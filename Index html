<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gesture Particle Playground</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
:root {
  --panel-bg: rgba(20,20,24,0.85);
  --accent: #ff5fa2;
  --text: #f2f2f2;
}

html, body {
  margin: 0;
  padding: 0;
  background: #0b0b0f;
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  overflow: hidden;
}

canvas {
  display: block;
}

#ui {
  position: fixed;
  top: 16px;
  left: 16px;
  width: 280px;
  background: var(--panel-bg);
  border-radius: 16px;
  padding: 14px;
  box-shadow: 0 20px 40px rgba(0,0,0,.4);
  backdrop-filter: blur(12px);
}

h3 {
  margin: 6px 0 10px;
  font-size: 14px;
  opacity: .85;
}

.row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

button, select, input[type="range"], input[type="color"] {
  background: #1c1c22;
  color: var(--text);
  border: none;
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
}

button {
  cursor: pointer;
}

button.active {
  outline: 2px solid var(--accent);
}

label {
  font-size: 11px;
  opacity: .7;
}

#readme {
  position: fixed;
  right: 16px;
  bottom: 16px;
  width: 300px;
  background: var(--panel-bg);
  padding: 14px;
  border-radius: 16px;
  font-size: 12px;
  line-height: 1.5;
}

#readme b {
  color: var(--accent);
}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div id="ui">
  <h3>Particle Template</h3>
  <div class="row">
    <button data-template="heart">‚ù§Ô∏è</button>
    <button data-template="flower">üå∏</button>
    <button data-template="saturn">ü™ê</button>
    <button data-template="buddha">üßò</button>
    <button data-template="fireworks">üéÜ</button>
  </div>

  <h3>Appearance</h3>
  <div class="row">
    <input type="color" id="color" value="#ff5fa2">
    <label>Count</label><input type="range" id="count" min="500" max="8000" value="3000">
    <label>Size</label><input type="range" id="size" min="1" max="8" value="3">
    <label>Noise</label><input type="range" id="noise" min="0" max="2" step="0.01" value="0.4">
  </div>

  <h3>Input</h3>
  <div class="row">
    <button id="toggleCam" class="active">üì∑ Camera</button>
    <button id="screenshot">üì∏ PNG</button>
  </div>
</div>

<div id="readme">
<b>Gestures</b><br>
‚Ä¢ Open hands ‚Üí expand particles<br>
‚Ä¢ Close fists ‚Üí contract<br>
‚Ä¢ Move hands apart ‚Üí scale up<br>
‚Ä¢ Quick close ‚Üí fireworks burst<br><br>
<b>Fallback</b><br>
‚Ä¢ Mouse / touch drag = scale & spread<br><br>
<b>Performance</b><br>
‚Ä¢ Reduce particle count on slow devices<br>
‚Ä¢ Camera can be disabled anytime
</div>

<script>
/* ===============================
   THREE.JS SETUP
================================ */
const canvas = document.getElementById("c");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
camera.position.z = 12;

window.addEventListener("resize", () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

/* ===============================
   PARTICLE SHADER
================================ */
const uniforms = {
  uTime: { value: 0 },
  uSize: { value: 3 },
  uColor: { value: new THREE.Color("#ff5fa2") },
};

const material = new THREE.ShaderMaterial({
  uniforms,
  transparent: true,
  depthWrite: false,
  vertexShader: `
    uniform float uTime;
    uniform float uSize;
    attribute vec3 target;
    varying float vAlpha;

    void main() {
      vec3 p = mix(position, target, 0.1);
      vAlpha = 1.0;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
      gl_PointSize = uSize * (300.0 / -gl_Position.z);
    }
  `,
  fragmentShader: `
    uniform vec3 uColor;
    varying float vAlpha;
    void main() {
      float d = length(gl_PointCoord - 0.5);
      if (d > 0.5) discard;
      gl_FragColor = vec4(uColor, vAlpha);
    }
  `
});

/* ===============================
   PARTICLE GEOMETRY
================================ */
let count = 3000;
let geometry, points;
let targets = [];

function makeGeometry() {
  geometry = new THREE.BufferGeometry();
  const pos = new Float32Array(count * 3);
  targets = new Float32Array(count * 3);

  for (let i = 0; i < count; i++) {
    pos[i*3+0] = (Math.random()-0.5)*5;
    pos[i*3+1] = (Math.random()-0.5)*5;
    pos[i*3+2] = (Math.random()-0.5)*5;
  }

  geometry.setAttribute("position", new THREE.BufferAttribute(pos, 3));
  geometry.setAttribute("target", new THREE.BufferAttribute(targets, 3));
  points = new THREE.Points(geometry, material);
  scene.add(points);
}

makeGeometry();

/* ===============================
   SHAPE TEMPLATES
================================ */
function setTemplate(type) {
  for (let i = 0; i < count; i++) {
    let x=0,y=0,z=0;
    const a = Math.random()*Math.PI*2;
    const r = Math.random();

    if (type === "heart") {
      x = 16*Math.pow(Math.sin(a),3);
      y = 13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a);
    }
    if (type === "flower") {
      x = Math.cos(a)*(2+r*Math.sin(5*a));
      y = Math.sin(a)*(2+r*Math.sin(5*a));
    }
    if (type === "saturn") {
      x = Math.cos(a)*4;
      y = (Math.random()-0.5)*0.5;
      z = Math.sin(a)*4;
    }
    if (type === "buddha") {
      x = (Math.random()-0.5)*2;
      y = Math.abs(Math.random()*3);
    }
    if (type === "fireworks") {
      x = Math.cos(a)*r*5;
      y = Math.sin(a)*r*5;
      z = (Math.random()-0.5)*5;
    }

    targets[i*3]=x*0.1;
    targets[i*3+1]=y*0.1;
    targets[i*3+2]=z*0.1;
  }
}

setTemplate("heart");

/* ===============================
   UI EVENTS
================================ */
document.querySelectorAll("[data-template]").forEach(b=>{
  b.onclick=()=>setTemplate(b.dataset.template);
});

document.getElementById("color").oninput=e=>{
  uniforms.uColor.value.set(e.target.value);
};

document.getElementById("size").oninput=e=>{
  uniforms.uSize.value = e.target.value;
};

document.getElementById("count").oninput=e=>{
  scene.remove(points);
  count = +e.target.value;
  makeGeometry();
};

/* ===============================
   HAND TRACKING
================================ */
let camEnabled = true;
let handScale = 1;

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands: 2,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(res=>{
  if (!camEnabled || res.multiHandLandmarks?.length < 2) return;

  const [h1,h2] = res.multiHandLandmarks;
  const d = Math.hypot(
    h1[0].x - h2[0].x,
    h1[0].y - h2[0].y
  );

  handScale = THREE.MathUtils.lerp(handScale, d*3, 0.2);
  points.scale.setScalar(handScale);
});

const video = document.createElement("video");
new Camera(video, {
  onFrame: async()=>hands.send({image:video}),
  width:640, height:480
}).start();

document.getElementById("toggleCam").onclick=()=>{
  camEnabled=!camEnabled;
  document.getElementById("toggleCam").classList.toggle("active", camEnabled);
};

/* ===============================
   SCREENSHOT
================================ */
document.getElementById("screenshot").onclick=()=>{
  const a=document.createElement("a");
  a.href=renderer.domElement.toDataURL("image/png");
  a.download="particles.png";
  a.click();
};

/* ===============================
   ANIMATION LOOP
================================ */
function animate(t){
  uniforms.uTime.value = t*0.001;
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
